<script>
    var Interactor = function (config) {
        // Call Initialization on Interactor Call
        this.__init__(config);
    };

    Interactor.prototype = {

        // Initialization
        __init__: function (config) {

            var interactor = this;

            // Argument Assignment          // Type Checks                                                                          // Default Values
            interactor.interactions = typeof (config.interactions) == "boolean" ? config.interactions : true,
                interactor.interactionElement = typeof (config.interactionElement) == "string" ? config.interactionElement : 'interaction',
                interactor.interactionEvents = Array.isArray(config.interactionEvents) === true ? config.interactionEvents : ['mouseup', 'touchend'],
                interactor.conversions = typeof (config.conversions) == "boolean" ? config.conversions : true,
                interactor.conversionElement = typeof (config.conversionElement) == "string" ? config.conversionElement : 'conversion',
                interactor.conversionEvents = Array.isArray(config.conversionEvents) === true ? config.conversionEvents : ['mouseup', 'touchend'],
                interactor.endpoint = typeof (config.endpoint) == "string" ? config.endpoint : '/interactions',
                interactor.async = typeof (config.async) == "boolean" ? config.async : true,
                interactor.debug = typeof (config.debug) == "boolean" ? config.debug : true,
                interactor.records = [],
                interactor.session = {},
                interactor.loadTime = new Date();

            // Initialize Session
            interactor.__initializeSession__();
            // Call Event Binding Method
            interactor.__bindEvents__();


            return interactor;
        },

        // Create Events to Track
        __bindEvents__: function () {
            var interactor = this;

            // Set Interaction Capture
            if (interactor.interactions === true) {
                for (var i = 0; i < interactor.interactionEvents.length; i++) {
                    document.querySelector('body').addEventListener(interactor.interactionEvents[i], function (e) {
                        e.stopPropagation();
                        interactor.__addInteraction__(e, "interaction");
                    });
                }
            }

            // Bind onbeforeunload Event
            window.onbeforeunload = function (e) {
                interactor.__sendInteractions__();
            };

            return interactor;
        },

        // Add Interaction Object Triggered By Events to Records Array
        __addInteraction__: function (e, type) {

            var interactor = this;

            date = new Date();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var seconds = date.getSeconds();
            trackingEntity = {
                date: `${date.getFullYear()}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`,
                time: `${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`,
                page: interactor.session.page.href,
                element_type: "button",
                element_name: "name",
                action_type: "conversation",
                event_type: "mousedown"
            }
            // Insert into Records Array
            interactor.records.push(trackingEntity);

            // Log Interaction if Debugging
            if (interactor.debug) {
                // Close Session & Log to Console
                interactor.__closeSession__();
                console.log("Session:\n", interactor.session);
            }

            return interactor;
        },

        // Generate Session Object & Assign to Session Property
        __initializeSession__: function () {
            var interactor = this;

            // Assign Session Property
            interactor.session = {
                loadTime: interactor.loadTime,
                unloadTime: new Date(),
                language: window.navigator.language,
                platform: window.navigator.platform,
                port: window.location.port,
                clientStart: {
                    name: window.navigator.appVersion,
                    innerWidth: window.innerWidth,
                    innerHeight: window.innerHeight,
                    outerWidth: window.outerWidth,
                    outerHeight: window.outerHeight
                },
                page: {
                    location: window.location.pathname,
                    href: window.location.href,
                    origin: window.location.origin,
                    title: document.title
                },
                endpoint: interactor.endpoint
            };

            return interactor;
        },

        // Insert End of Session Values into Session Property
        __closeSession__: function () {

            var interactor = this;

            // Assign Session Properties
            interactor.session.unloadTime = new Date();
            interactor.session.interactions = interactor.records;
            interactor.session.clientEnd = {
                name: window.navigator.appVersion,
                innerWidth: window.innerWidth,
                innerHeight: window.innerHeight,
                outerWidth: window.outerWidth,
                outerHeight: window.outerHeight
            };

            return interactor;
        },


        // Gather Additional Data and Send Interaction(s) to Server
        __sendInteractions__: function () {

            var interactor = this,
                // Initialize Cross Header Request
                xhr = new XMLHttpRequest();

            // Close Session
            interactor.__closeSession__();

            // Post Session Data Serialized as JSON
            xhr.open('POST', interactor.endpoint, interactor.async);
            xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            var trackingEntity = {
                student: "Иванов Иван",
                group: 1303,
                email: "iiivanov@edu.ru",
                course: "Курс молодого бойца",
                session: "123",
                actions: interactor.records
            }
            
            xhr.send(JSON.stringify(trackingEntity));

            return interactor;
        }

    };
</script>

<script type="module">
    // An example instantiation with custom arguments
    var interactions = new Interactor({
        interactions: true,
        interactionElement: ["interaction", "main-inner"],
        interactionEvents: ["mousedown", "mouseup", "shiftKey", "touchstart", "touchend"],
        conversions: true,
        conversionElement: "conversion",
        conversionEvents: ["mouseup", "touchend"],
        endpoint: '/',
        async: true,
        debug: true
    });
</script>